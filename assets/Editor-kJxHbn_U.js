import{r as j,j as s,R as it}from"./index-BU-NPzoO.js";import{A as ct,G as lt,E as dt,S as ht,C as ut,B as pt}from"./AdvancedPanel-BN0HpQd_.js";const xt=({activePanel:t,panels:o,onPanelChange:n,className:a="",minHeight:e="400px"})=>{const[c,i]=j.useState(!1),[r,l]=j.useState(new Set([t])),u=j.useRef(null),[g,N]=j.useState(e);j.useEffect(()=>{const d=Object.keys(o),p=d.indexOf(t),C=[];p>0&&C.push(d[p-1]),p<d.length-1&&C.push(d[p+1]),C.forEach(M=>{r.has(M)||setTimeout(()=>{l(f=>new Set([...f,M]))},500)})},[t,o,r]);const h=d=>{r.has(d)||l(p=>new Set([...p,d]))},b=async d=>{if(!(d===t||c)){if(i(!0),u.current){const p=u.current.offsetHeight;N(`${p}px`)}r.has(d)||(l(p=>new Set([...p,d])),await new Promise(p=>setTimeout(p,100))),n(d),setTimeout(()=>{if(u.current){const p=u.current.cloneNode(!0);p.style.position="absolute",p.style.visibility="hidden",p.style.height="auto",p.style.top="-9999px",p.querySelectorAll("[data-panel]").forEach(f=>{f.style.display=f.dataset.panel===d?"block":"none"}),document.body.appendChild(p);const M=p.offsetHeight;document.body.removeChild(p),requestAnimationFrame(()=>{N(`${M}px`)})}},50),setTimeout(()=>{i(!1),N("auto")},350)}};return s.jsxs("div",{className:a,children:[s.jsx("div",{className:"flex gap-2 mb-6",children:Object.keys(o).map(d=>s.jsx("button",{className:`px-4 py-2 rounded-xl font-bold border-2 shadow transition-all duration-200 transform hover:scale-105 ${t===d?"bg-blue-500 text-white border-blue-700 shadow-lg":"bg-blue-100 text-blue-900 border-blue-300 hover:bg-blue-200"}`,onClick:()=>b(d),onMouseEnter:()=>h(d),disabled:c,children:o[d].title},d))}),s.jsxs("div",{ref:u,className:"relative overflow-hidden transition-all duration-300 ease-in-out",style:{height:g,minHeight:e},children:[c&&s.jsx("div",{className:"absolute inset-0 bg-white bg-opacity-50 flex items-center justify-center z-10 transition-opacity duration-150",children:s.jsxs("div",{className:"flex items-center gap-2 text-blue-600",children:[s.jsx("div",{className:"w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"}),s.jsx("span",{className:"text-sm font-medium",children:"Loading..."})]})}),s.jsx("div",{className:`transition-all duration-300 ${c?"opacity-70 scale-98":"opacity-100 scale-100"}`,children:Object.keys(o).map(d=>s.jsx("div",{"data-panel":d,className:`${t===d?"block":"hidden"}`,children:r.has(d)?s.jsx("div",{className:"panel-content-wrapper",children:o[d].component}):s.jsx("div",{className:"flex items-center justify-center py-8",children:s.jsxs("div",{className:"flex items-center gap-2 text-gray-500",children:[s.jsx("div",{className:"w-4 h-4 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"}),s.jsx("span",{children:"Loading panel..."})]})})},d))})]})]})},ft={selectedImage:null,edits:[],history:[],historyIndex:-1};function mt(t,o){switch(o.type){case"SELECT_IMAGE":return{...t,selectedImage:o.payload};case"APPLY_EDIT":const n=t.history.slice(0,t.historyIndex+1),a=[...t.edits,o.payload],e=[...n,a];return{...t,edits:a,history:e,historyIndex:e.length-1};case"UNDO":return t.historyIndex>0?{...t,edits:t.history[t.historyIndex-1],historyIndex:t.historyIndex-1}:t;case"REDO":return t.historyIndex<t.history.length-1?{...t,edits:t.history[t.historyIndex+1],historyIndex:t.historyIndex+1}:t;default:return t}}const nt=j.createContext(),gt=({children:t})=>{const[o,n]=j.useReducer(mt,ft);return s.jsx(nt.Provider,{value:{state:o,dispatch:n},children:t})},y=(t,o=0,n=255)=>Math.max(o,Math.min(n,t)),bt=(t,o)=>{if(o===1)return t;const n=t.data;for(let a=0;a<n.length;a+=4){const e=n[a],c=n[a+1],i=n[a+2],r=128,l=o<1?1+(1-o):1/o;n[a]=y(r+(e-r)*l),n[a+1]=y(r+(c-r)*l),n[a+2]=y(r+(i-r)*l)}return t},yt=(t,o)=>{if(o===1)return t;const n=t.data;for(let a=0;a<n.length;a+=4)for(let e=0;e<3;e++){const c=n[a+e]/255,i=(o-1)*4,r=c+Math.pow(c-.5,3)*i;n[a+e]=y(r*255)}return t},wt=(t,o)=>{if(o===1)return t;const{width:n,height:a,data:e}=t,c=new Uint8ClampedArray(e),i=(o-1)*.5;for(let r=0;r<e.length;r+=4){const l=c[r],u=c[r+1],g=c[r+2];e[r]=y(l*(1-i)+(u+g)*.5*i),e[r+1]=y(u*(1-i)+(l+g)*.5*i),e[r+2]=y(g*(1-i)+(l+u)*.5*i)}return t},jt=(t,o)=>{if(o===0)return t;const n=t.data;for(let a=0;a<n.length;a+=4){const e=n[a],c=n[a+1],i=n[a+2],r=.393*e+.769*c+.189*i,l=.349*e+.686*c+.168*i,u=.272*e+.534*c+.131*i;n[a]=y(e*(1-o)+r*o),n[a+1]=y(c*(1-o)+l*o),n[a+2]=y(i*(1-o)+u*o)}return t},vt=(t,o)=>{if(o===0)return t;const n=t.data;for(let a=0;a<n.length;a+=4){const e=n[a],c=n[a+1],i=n[a+2],r=(e+c+i)/3,l=Math.min(1,(i-e)/128)*(r/255),u=1+o*.3,g=o*l;n[a]=y((e-128)*u+128+g*20),n[a+1]=y((c-128)*u+128+g*10),n[a+2]=y((i-128)*u+128-g*30)}return t},St=(t,o)=>{if(o===1)return t;const n=t.data,a=(o-1)*.5;for(let e=0;e<n.length;e+=4)for(let c=0;c<3;c++){const r=n[e+c]/255;let l;r<.5?l=r+(.5-r)*a:l=r-(r-.5)*a,n[e+c]=y(l*255)}return t},Nt=(t,o)=>{if(o===0)return t;const{width:n,height:a,data:e}=t,c=new Uint8ClampedArray(e);for(let i=1;i<a-1;i++)for(let r=1;r<n-1;r++){const l=(i*n+r)*4,u=(i*n+(r-1))*4,g=(i*n+(r+1))*4,N=((i-1)*n+r)*4,h=((i+1)*n+r)*4;if(Math.abs(c[u]-c[g])+Math.abs(c[N]-c[h])>50){const d=(e[l]+e[l+1]+e[l+2])/3,p=o*.8;e[l]=Math.round(e[l]*(1-p)+d*p),e[l+1]=Math.round(e[l+1]*(1-p)+d*p),e[l+2]=Math.round(e[l+2]*(1-p)+d*p)}}return t},Ct=(t,o,n,a)=>{if(a===0)return t;const e=t.data,c=o/2,i=n/2,r=Math.sqrt(c*c+i*i),l=a>0,u=Math.abs(a);for(let g=0;g<n;g++)for(let N=0;N<o;N++){const h=(g*o+N)*4,b=N-c,d=g-i,p=Math.sqrt(b*b+d*d)/r,C=Math.pow(p,2.5)*u;l?(e[h]=y(e[h]+C*255),e[h+1]=y(e[h+1]+C*255),e[h+2]=y(e[h+2]+C*255)):(e[h]=y(e[h]*(1-C)),e[h+1]=y(e[h+1]*(1-C)),e[h+2]=y(e[h+2]*(1-C)))}return t},Et=(t,o,n,a)=>{if(a===0)return;const e=t.getImageData(0,0,o,n),c=e.data,i=a*30;for(let r=0;r<c.length;r+=4){const l=(Math.random()-.5)*2*i;c[r]=y(c[r]+l),c[r+1]=y(c[r+1]+l),c[r+2]=y(c[r+2]+l)}t.putImageData(e,0,0)},V=(t,o=0,n=255)=>Math.max(o,Math.min(n,t)),Mt=(t,o,n)=>{const{exposure:a=0,contrast:e=0,highlights:c=0,shadows:i=0,whites:r=0,blacks:l=0,gamma:u=1,vibrance:g=0,saturation:N=0,hue:h=0,temperature:b=0,tint:d=0,sharpness:p=0,clarity:C=0,blur:M=0,vignette:f=0,flipH:W=!1,flipV:J=!1,rotate:Q=0,crop:Ot=null,mask:Dt=null,customFilter:K=null,applyQuickAction:st=null,localBrushMask:Ht=null,hdr:P=1,curves:T=1,channelMixer:k=1,lut:O=0,defog:D=0,shadowHighlight:H=1,chromatic:L=0,advancedVignetting:G=0,filmGrain:U=0}=n||{},E=o.width,I=o.height;t.clearRect(0,0,E,I),t.save(),W||J||Q!==0?(t.translate(E/2,I/2),t.rotate(Q*Math.PI/180),t.scale(W?-1:1,J?-1:1),t.drawImage(o,-E/2,-I/2)):t.drawImage(o,0,0),t.restore();let v=t.getImageData(0,0,E,I);const R=v.data;for(let w=0;w<R.length;w+=4){let m=R[w],x=R[w+1],S=R[w+2];m+=a*255,x+=a*255,S+=a*255;const X=259*(e+255)/(255*(259-e));m=X*(m-128)+128,x=X*(x-128)+128,S=X*(S-128)+128,m=255*Math.pow(m/255,1/u),x=255*Math.pow(x/255,1/u),S=255*Math.pow(S/255,1/u);const Y=(m+x+S)/3;m+=(m-Y)*(N/100),x+=(x-Y)*(N/100),S+=(S-Y)*(N/100);const z=Math.max(m,x,S),$=g/100;if(m+=(z-m)*$,x+=(z-x)*$,S+=(z-S)*$,h!==0){const tt=h*Math.PI/180,B=Math.cos(tt),Z=Math.sin(tt),_=.213+B*.787-Z*.213,F=.715-B*.715-Z*.715,q=.072-B*.072+Z*.928,ot=m*_+x*F+S*q,at=m*F+x*_+S*q,rt=m*q+x*F+S*_;m=ot,x=at,S=rt}m+=b,S-=b,x+=d,R[w]=V(m,0,255),R[w+1]=V(x,0,255),R[w+2]=V(S,0,255)}if(t.putImageData(v,0,0),M>0){t.globalAlpha=.5;for(let w=1;w<=M;w++)t.drawImage(t.canvas,w,0),t.drawImage(t.canvas,-w,0),t.drawImage(t.canvas,0,w),t.drawImage(t.canvas,0,-w);t.globalAlpha=1}if(f>0){const w=t.createRadialGradient(E/2,I/2,E*.2,E/2,I/2,E*.5);w.addColorStop(0,"rgba(0,0,0,0)"),w.addColorStop(1,`rgba(0,0,0,${f/100})`),t.fillStyle=w,t.fillRect(0,0,E,I)}if(K&&K(t,v),st==="bw"){const w=t.getImageData(0,0,E,I),m=w.data;for(let x=0;x<m.length;x+=4){const S=(m[x]+m[x+1]+m[x+2])/3;m[x]=m[x+1]=m[x+2]=S}t.putImageData(w,0,0)}v=t.getImageData(0,0,E,I),(P!==1||T!==1||k!==1||O!==0||D!==0||H!==1||L!==0||G!==0||U!==0)&&(P!==1&&(v=bt(v,P)),T!==1&&(v=yt(v,T)),k!==1&&(v=wt(v,k)),O!==0&&(v=jt(v,O)),D!==0&&(v=vt(v,D)),H!==1&&(v=St(v,H)),L!==0&&(v=Nt(v,L)),G!==0&&(v=Ct(v,E,I,G)),t.putImageData(v,0,0),U>0&&Et(t,E,I,U))},et=({imageSrc:t,edits:o,onProcessed:n})=>{const a=j.useRef(null),[e,c]=j.useState(null);return j.useEffect(()=>{if(!t)return;const i=new window.Image;i.onload=()=>c(i),i.src=t},[t]),j.useEffect(()=>{if(!e||!a.current)return;const i=a.current,r=i.getContext("2d");i.width=e.width,i.height=e.height,Mt(r,e,o),n&&n(i.toDataURL())},[e,o]),s.jsx("div",{className:"relative",children:s.jsx("canvas",{ref:a,className:"w-full max-w-full h-auto rounded-xl border border-gray-700 shadow-lg"})})},It=({canUndo:t,canRedo:o,onUndo:n,onRedo:a})=>s.jsxs("div",{className:"flex gap-2 mb-4",children:[s.jsx("button",{className:"bg-gray-700 text-white px-4 py-2 rounded",onClick:n,disabled:!t,children:"Undo"}),s.jsx("button",{className:"bg-gray-700 text-white px-4 py-2 rounded",onClick:a,disabled:!o,children:"Redo"})]}),Rt=({onZoom:t,onPan:o})=>{const[n,a]=j.useState(1),[e,c]=j.useState({x:0,y:0}),i=h=>{const b=Number(h.target.value);a(b),t(b)},r=20,l=(h,b)=>{const d={x:e.x+h,y:e.y+b};c(d),o&&o(d)},u=j.useRef({}),g=h=>{if(h.touches.length===2){const b=h.touches[0].clientX-h.touches[1].clientX,d=h.touches[0].clientY-h.touches[1].clientY;u.current.pinchStartDist=Math.sqrt(b*b+d*d),u.current.zoomStart=n}else h.touches.length===1&&(u.current.panStartX=h.touches[0].clientX,u.current.panStartY=h.touches[0].clientY,u.current.panStart={...e})},N=h=>{if(h.touches.length===2&&u.current.pinchStartDist){const b=h.touches[0].clientX-h.touches[1].clientX,d=h.touches[0].clientY-h.touches[1].clientY,C=Math.sqrt(b*b+d*d)/u.current.pinchStartDist,M=Math.max(1,Math.min(5,u.current.zoomStart*C));a(M),t(M)}else if(h.touches.length===1&&u.current.panStartX!==void 0){const b=h.touches[0].clientX-u.current.panStartX,d=h.touches[0].clientY-u.current.panStartY,p={x:u.current.panStart.x+b,y:u.current.panStart.y+d};c(p),o&&o(p)}};return s.jsxs("div",{className:"flex flex-col gap-2 mb-4",onTouchStart:g,onTouchMove:N,children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"text-white",children:"Zoom:"}),s.jsx("input",{type:"range",min:1,max:5,step:.1,value:n,onChange:i}),s.jsxs("span",{className:"text-gray-400",children:[n,"x"]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("label",{className:"text-white",children:"Pan:"}),s.jsx("button",{className:"bg-gray-700 text-white px-2 rounded",onClick:()=>l(-r,0),children:"←"}),s.jsx("button",{className:"bg-gray-700 text-white px-2 rounded",onClick:()=>l(r,0),children:"→"}),s.jsx("button",{className:"bg-gray-700 text-white px-2 rounded",onClick:()=>l(0,-r),children:"↑"}),s.jsx("button",{className:"bg-gray-700 text-white px-2 rounded",onClick:()=>l(0,r),children:"↓"})]})]})},At=({metadata:t,onSave:o})=>{const[n,a]=j.useState(!1),[e,c]=j.useState(t||{}),i=(l,u)=>{c({...e,[l]:u})},r=()=>{a(!1),o&&o(e)};return s.jsxs("div",{className:"bg-editor-bg p-4 rounded-xl text-white border border-editor-border max-h-80 overflow-y-auto exif-panel",children:[s.jsx("h3",{className:"font-bold mb-2 text-primary",children:"EXIF Metadata"}),s.jsx("ul",{children:e?Object.entries(e).map(([l,u])=>s.jsxs("li",{className:"mb-1",children:[s.jsxs("span",{className:"font-semibold text-accent",children:[l,":"]}),n?s.jsx("input",{className:"ml-2 p-1 rounded bg-gray-700 text-white",value:u,onChange:g=>i(l,g.target.value)}):s.jsx("span",{className:"ml-2",children:u})]},l)):s.jsx("li",{children:"No metadata available."})}),s.jsx("div",{className:"mt-2",children:n?s.jsx("button",{className:"bg-success text-white px-3 py-1 rounded",onClick:r,children:"Save"}):s.jsx("button",{className:"bg-primary text-white px-3 py-1 rounded",onClick:()=>a(!0),children:"Edit"})})]})};let A=null;async function Pt(){return A||(A={decode:async t=>({jpegPreview:t.preview})},A)}async function Tt(t){try{return await(await Pt()).decode(t)}catch(o){throw console.error("LibRaw WASM decode error:",o),new Error("RAW decode failed")}}const kt=({imageFile:t,metadata:o})=>{const{state:n,dispatch:a}=j.useContext(nt),[e,c]=j.useState(1),[i,r]=j.useState({x:0,y:0}),[l,u]=j.useState(null),[g,N]=j.useState("basic"),[h,b]=j.useState(!1);it.useEffect(()=>{t&&Tt(t).then(f=>u(f.jpegPreview))},[t]);const d=()=>a({type:"UNDO"}),p=()=>a({type:"REDO"}),C=f=>c(f),M=f=>r(f);return s.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-100 via-white to-blue-300 text-black flex flex-col items-center py-20",children:[s.jsx("h1",{className:"text-4xl font-bold mb-8",children:"Edit Photo"}),s.jsxs("div",{className:"flex gap-8",children:[s.jsxs("div",{className:"bg-white bg-opacity-90 rounded-2xl p-6 shadow-2xl w-[500px]",children:[s.jsx(xt,{activePanel:g,onPanelChange:N,minHeight:"300px",panels:{basic:{title:"Basic",component:s.jsx(pt,{adjustments:n.basic||{exposure:1,contrast:1,highlights:1,shadows:1,whites:1,blacks:1,gamma:1},onChange:f=>a({type:"SET_BASIC",payload:f})})},color:{title:"Color",component:s.jsx(ut,{colorAdjustments:n.color,onChange:f=>a({type:"SET_COLOR",payload:f})})},sharpness:{title:"Sharpness",component:s.jsx(ht,{sharpness:n.sharpness,onChange:f=>a({type:"SET_SHARPNESS",payload:f})})},effects:{title:"Effects",component:s.jsx(dt,{effects:n.effects,onChange:f=>a({type:"SET_EFFECTS",payload:f})})},geometry:{title:"Geometry",component:s.jsx(lt,{geometry:n.geometry,onChange:f=>a({type:"SET_GEOMETRY",payload:f})})},advanced:{title:"Advanced",component:s.jsx(ct,{advanced:n.advanced,onChange:f=>a({type:"SET_ADVANCED",payload:f})})}}}),s.jsxs("div",{className:"flex flex-wrap gap-4 mt-8",children:[s.jsxs("select",{className:"bg-blue-500 text-white font-bold px-6 py-3 rounded-xl shadow-lg border-2 border-blue-700 hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-200",children:[s.jsx("option",{value:"jpeg",children:"JPEG"}),s.jsx("option",{value:"png",children:"PNG"}),s.jsx("option",{value:"raw",children:"RAW"})]}),s.jsx("button",{className:"bg-blue-700 text-white font-bold px-6 py-3 rounded-xl shadow border-2 border-blue-800 hover:bg-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-400 transition duration-200",children:"Download"}),s.jsx("button",{className:"bg-blue-500 text-white font-bold px-6 py-3 rounded-xl shadow border-2 border-blue-700 hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-200",children:"Save"})]})]}),s.jsxs("div",{className:"flex flex-col gap-4 w-[700px]",children:[s.jsxs("div",{className:"flex gap-4 items-center",children:[s.jsxs("div",{className:`rounded-2xl shadow-lg bg-white bg-opacity-80 border border-blue-200 ${h?"w-1/2":"hidden"}`,children:[s.jsx(et,{image:l,edits:[],zoom:e,pan:i}),s.jsx("div",{className:"text-center text-xs font-bold text-blue-700",children:"Original"})]}),s.jsxs("div",{className:`rounded-2xl shadow-lg bg-white bg-opacity-80 border border-blue-200 ${h?"w-1/2":"w-full"}`,children:[s.jsx(et,{image:l,edits:n.edits,zoom:e,pan:i}),s.jsx("div",{className:"text-center text-xs font-bold text-blue-700",children:"Edited"})]}),s.jsx("button",{className:"ml-4 px-3 py-2 rounded-xl bg-blue-500 text-black font-bold border-2 border-blue-700 shadow hover:bg-blue-600 transition duration-200",onClick:()=>b(!h),children:h?"Minimize Original":"Show Original"})]}),s.jsx(Rt,{onZoom:C,onPan:M}),s.jsx(It,{canUndo:n.historyIndex>0,canRedo:n.historyIndex<n.history.length-1,onUndo:d,onRedo:p}),s.jsx(At,{metadata:o})]})]})]})},Ut=t=>s.jsx(gt,{children:s.jsx(kt,{...t})});export{Ut as default};
